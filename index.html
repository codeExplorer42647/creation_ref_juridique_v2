<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Générateur de références</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    label { display:block; margin-top:1rem; }
    input, select, textarea { width:100%; padding:0.4rem; margin-top:0.2rem; }
    button { margin-top:1rem; padding:0.6rem 1rem; }
    table { border-collapse: collapse; width:100%; margin-top:1rem; }
    th, td { border:1px solid #ccc; padding:0.4rem; text-align:left; }
  </style>
</head>
<body>
  <h1>Générateur de références de procédure</h1>
  <form id="form">
    <label>Type de procédure
      <select id="type">
        <option value="C">C — Civil / Responsabilité</option>
        <option value="M" selected>M — Médical / Santé</option>
        <option value="S">S — Successoral / Héritage</option>
        <option value="I">I — Immobilier</option>
        <option value="A">A — Académique / Étudiant</option>
      </select>
    </label>
    <label>Date (ISO)
      <input type="date" id="date" />
    </label>
    <label>Juridiction (code interne)
      <input id="jur" placeholder="CH-BL / ES-LE / ..." />
    </label>
    <label>Canal
      <input id="canal" placeholder="WEB / CLI / MOBILE" />
    </label>
    <label>Secret (secret_salt)
      <input type="password" id="secret" />
      <span><input type="checkbox" id="remember" /> Mémoriser localement le secret (optionnel)</span>
    </label>
    <button type="button" id="generate">Générer la référence</button>
    <button type="button" id="copy">Copier</button>
    <button type="button" id="export">Exporter l'historique (CSV)</button>
  </form>

  <label>Référence générée
    <textarea id="result" readonly rows="2" placeholder="—"></textarea>
  </label>
  <div id="error" style="color:red; margin-top:0.5rem;"></div>

  <h2>Historique (local)</h2>
  <table id="history">
    <thead>
      <tr><th>ID</th><th>Type</th><th>Date</th><th>Juridiction</th><th>Canal</th><th>Créé le</th></tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const VERSION = "v1";
const ID_REGEX = /^[0-9A-F]{7}[CMSIA]$/;
const LS_IDS = "hexRef:ids";
const LS_BASE_INDEX = "hexRef:baseIndex";
const LS_COUNTERS = "hexRef:counters";
const LS_HISTORY = "hexRef:history";
const LS_SECRET = "hexRef:secret";
const LS_REMEMBER = "hexRef:remember";

function todayISO(){
  const d=new Date();
  const tz=new Date(d.getTime()-d.getTimezoneOffset()*60000);
  return tz.toISOString().slice(0,10);
}

function toUpperHex(buffer){
  const bytes=new Uint8Array(buffer);
  let hex="";
  for(let b of bytes){
    hex+=b.toString(16).padStart(2,"0");
  }
  return hex.toUpperCase();
}

async function hmacSHA256_hex(keyStr,message){
  const enc=new TextEncoder();
  const keyData=enc.encode(keyStr);
  const msgData=enc.encode(message);
  const cryptoKey=await crypto.subtle.importKey("raw",keyData,{name:"HMAC",hash:{name:"SHA-256"}},false,["sign"]);
  const sig=await crypto.subtle.sign("HMAC",cryptoKey,msgData);
  return toUpperHex(sig);
}

function readJSON(key,fallback){
  try{
    const raw=localStorage.getItem(key);
    if(!raw) return fallback;
    return JSON.parse(raw);
  }catch(e){
    return fallback;
  }
}

function writeJSON(key,value){
  localStorage.setItem(key,JSON.stringify(value));
}

function normalizeInputs(raw){
  const type=(raw.type||"M").toUpperCase();
  const date=raw.date||todayISO();
  const juridiction=(raw.juridiction||"CH-BL").toUpperCase();
  const canal=(raw.canal||"WEB").toUpperCase();
  const secret_salt=raw.secret_salt||"";
  const base=baseCanonicalOf({type,date,juridiction,canal});
  const compteur=lastCounter(base);
  return {type,date,juridiction,canal,secret_salt,compteur_local:compteur};
}

function baseCanonicalOf(inputs){
  return `${VERSION}|${inputs.type}|${inputs.date}|${inputs.juridiction}|${inputs.canal}`;
}

function fullCanonicalOf(inputs){
  return `${baseCanonicalOf(inputs)}|${inputs.compteur_local}|${inputs.secret_salt}`;
}

function existsId(id){
  const ids=readJSON(LS_IDS,{});
  return Boolean(ids[id]);
}

function saveContext(ctx){
  const ids=readJSON(LS_IDS,{});
  ids[ctx.id]=ctx;
  writeJSON(LS_IDS,ids);
  const base=readJSON(LS_BASE_INDEX,{});
  base[ctx.baseCanonical]=ctx.id;
  writeJSON(LS_BASE_INDEX,base);
  const hist=readJSON(LS_HISTORY,[]);
  hist.unshift({id:ctx.id,type:ctx.type,date:ctx.date,juridiction:ctx.juridiction,canal:ctx.canal,createdAt:ctx.createdAt});
  writeJSON(LS_HISTORY,hist);
}

function getIdByBase(baseCanonical){
  const base=readJSON(LS_BASE_INDEX,{});
  const id=base[baseCanonical];
  if(!id) return null;
  const ids=readJSON(LS_IDS,{});
  const ctx=ids[id];
  return ctx?ctx.id:null;
}

function bumpCounter(baseCanonical,value){
  const counters=readJSON(LS_COUNTERS,{});
  counters[baseCanonical]=value;
  writeJSON(LS_COUNTERS,counters);
}

function lastCounter(baseCanonical){
  const counters=readJSON(LS_COUNTERS,{});
  return counters[baseCanonical]||0;
}

async function generateId(raw){
  let inputs=normalizeInputs(raw);
  const baseCanonical=baseCanonicalOf(inputs);
  const existing=getIdByBase(baseCanonical);
  if(existing) return existing;
  for(let tries=0; tries<=5; tries++){
    const canonical=fullCanonicalOf(inputs);
    const digestHex=await hmacSHA256_hex(inputs.secret_salt,canonical);
    const hex7=digestHex.slice(0,7).toUpperCase();
    const id=`${hex7}${inputs.type}`;
    if(!ID_REGEX.test(id)) throw new Error("ID généré invalide (format)");
    if(!existsId(id)){
      const ctx={id,baseCanonical,fullCanonical:canonical,type:inputs.type,date:inputs.date,juridiction:inputs.juridiction,canal:inputs.canal,compteur_local:inputs.compteur_local,createdAt:new Date().toISOString()};
      saveContext(ctx);
      bumpCounter(baseCanonical,inputs.compteur_local+1);
      return id;
    }else{
      const ids=readJSON(LS_IDS,{});
      const found=ids[id];
      if(found && found.fullCanonical===canonical) return id;
      inputs.compteur_local++;
    }
  }
  throw new Error("Collision non résolue après 6 tentatives");
}

function loadHistory(){
  const hist=readJSON(LS_HISTORY,[]);
  const tbody=document.querySelector('#history tbody');
  tbody.innerHTML="";
  for(const h of hist){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${h.id}</td><td>${h.type}</td><td>${h.date}</td><td>${h.juridiction}</td><td>${h.canal}</td><td>${new Date(h.createdAt).toLocaleString()}</td>`;
    tbody.appendChild(tr);
  }
}

function exportCSV(){
  const hist=readJSON(LS_HISTORY,[]);
  if(hist.length===0) return;
  const header=['id','type','date','juridiction','canal','createdAt'];
  const rows=[header.join(',')];
  for(const h of hist){
    rows.push([h.id,h.type,h.date,h.juridiction,h.canal,h.createdAt].join(','));
  }
  const blob=new Blob([rows.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='historique.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function init(){
  document.getElementById('date').value=todayISO();
  document.getElementById('jur').value='CH-BL';
  document.getElementById('canal').value='WEB';
  const remember=readJSON(LS_REMEMBER,false);
  document.getElementById('remember').checked=remember;
  if(remember){
    document.getElementById('secret').value=readJSON(LS_SECRET,'');
  }
  loadHistory();
}

async function onGenerate(){
  const type=document.getElementById('type').value;
  const date=document.getElementById('date').value;
  const jur=document.getElementById('jur').value;
  const canal=document.getElementById('canal').value;
  const secret=document.getElementById('secret').value;
  const remember=document.getElementById('remember').checked;
  if(remember){
    writeJSON(LS_SECRET,secret);
    writeJSON(LS_REMEMBER,true);
  }else{
    localStorage.removeItem(LS_SECRET);
    writeJSON(LS_REMEMBER,false);
  }
  try{
    const id=await generateId({type,date,juridiction:jur,canal,secret_salt:secret});
    document.getElementById('result').value=id;
    document.getElementById('error').textContent="";
    loadHistory();
  }catch(e){
    document.getElementById('error').textContent=e.message;
  }
}

function copyToClipboard(){
  const val=document.getElementById('result').value;
  if(!val) return;
  navigator.clipboard.writeText(val);
}

init();

 document.getElementById('generate').addEventListener('click',onGenerate);
 document.getElementById('copy').addEventListener('click',copyToClipboard);
 document.getElementById('export').addEventListener('click',exportCSV);
</script>
</body>
</html>
